<!DOCTYPE html>
<html lang="ru">
	<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5">
	<meta name="description" content="IT простым языком">
	<meta name="generator" content="HUGO">

	<meta name="theme-color" content="#ffffff">

    
    <link rel="stylesheet" href="/sass/main.min.2410c89c79b6e042a424a6cef6ba5cbff430844ddffbec9f142931da8c515642.css" integrity="sha256-JBDInHm24EKkJKbO9rpcv/QwhE3f&#43;&#43;yfFCkx2oxRVkI=">
    <title> IT простым языком </title>
</head>

<body>
	<div id="top"/>
<header>
    <div align="center">
        +---------------------------+<br>
        |.-------------------------.|<br>
        ||&nbsp;<a href="/">kee_reel@blog</a>:~$ cd&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;||<br>
        ||&nbsp;<a href="/c">c</a>&nbsp;&nbsp;<a href="/cpp">c++</a>&nbsp;&nbsp;<a href="/python">python</a>&nbsp;&nbsp;<a href="/linux">linux</a>&nbsp;&nbsp;&nbsp;||<br>
        ||&nbsp;<a href="/opengl">opengl</a>&nbsp;&nbsp;<a href="/sql">sql</a>&nbsp;&nbsp;<a href="/network">networks</a>&nbsp;&nbsp;&nbsp;||<br>
        ||&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;||<br>
        ||&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="/about">обо_мне</a>&nbsp;||<br>
        |.-------------------------.|<br>
        +-::---------------------::-+<br>
        .---------------------------.<br>
        &nbsp;//&nbsp;/o<a href="/links">o</a>oooooooooooooooooooo\\&nbsp;\\&nbsp;<br>
        &nbsp;//&nbsp;/oooooooooooooooooooooooo\\&nbsp;\\&nbsp;<br>
        //-------------------------------\\<br>
        \\-------------------------------//<br>
    </div>
    <hr>
</header>

		
	<div id="wrapper">
		<div class="container">
			<section id="main_content">
    
    
        <div style="display: flex; justify-content: space-between;">
            
                <a href="https://kee-reel.com/cpp/classes/">◀ Классы</a>
            
            
                <a href="https://kee-reel.com/cpp/constructors/">Конструкторы, оператор присваивания и деструктор ▶</a>
            
        </div>
        <hr>
    
    <h1>C&#43;&#43;. Переопределение операторов</h1>
    
    
        <h3>Время чтения: 7 мин</h3>
    
    <p>Прежде чем я расскажу про операторы в классах, давай я приведу пример, от которого будем отталкиваться.</p>
<blockquote>
<p>Я буду основываться на коде, приведённом в основной <a href="../classes">статье</a> про классы.</p>
</blockquote>
<p>Например, я хочу добавить возможность переливать кофе из одной кружки в другую (ты очень любишь кофе, а твой друг не допил).</p>
<p>Я мог бы добавить в класс Coffee новый метод pour (англ. &ndash; налить):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">pour</span>(Coffee <span style="color:#f92672">&amp;</span>other_cup)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Сравниваем адреса объектов, чтобы понять что это разные объекты
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(<span style="color:#66d9ef">this</span> <span style="color:#f92672">==</span> <span style="color:#f92672">&amp;</span>other_cup)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;Can&#39;t pour one cup into itself!&#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Сливаем только одинаковый тип кофе (чтобы не получить бурду)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>strcmp(m_type, other_cup.m_type))
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Предположим, что у нас бесконечно глубокая кружка
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;Poured &#34;</span> <span style="color:#f92672">&lt;&lt;</span> other_cup.m_volume <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;ml of&#34;</span> <span style="color:#f92672">&lt;&lt;</span> m_type <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34; from one cup to another.&#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>		m_volume <span style="color:#f92672">+=</span> other_cup.m_volume;
</span></span><span style="display:flex;"><span>		other_cup.m_volume <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;Coffee types &#34;</span> <span style="color:#f92672">&lt;&lt;</span> m_type <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34; and &#34;</span> <span style="color:#f92672">&lt;&lt;</span> other_cup.m_type <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34; doesn&#39;t match!&#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
<p>Смотри, я использовал &ldquo;this&rdquo; чтобы внутри метода получить адрес текущего объекта. Запомни &ldquo;this&rdquo; &ndash; он периодически пригождается.</p>
</blockquote>
<p>Теперь можно будет переливать из одной кружки в другую:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    Coffee c1(<span style="color:#e6db74">&#34;espresso&#34;</span>, <span style="color:#f92672">+</span><span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">50</span>); 
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Created 50ml cup of hot espresso coffee.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Coffee c2(<span style="color:#e6db74">&#34;americano&#34;</span>, <span style="color:#f92672">+</span><span style="color:#ae81ff">45</span>, <span style="color:#ae81ff">100</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Created 100ml cup of warm americano coffee.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Coffee c3(<span style="color:#e6db74">&#34;americano&#34;</span>, <span style="color:#f92672">+</span><span style="color:#ae81ff">45</span>, <span style="color:#ae81ff">200</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Created 200ml cup of warm americano coffee.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    c3.pour(c3);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Can&#39;t pour one cup into itself!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    c3.pour(c1);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Coffee types americano and espresso doesn&#39;t match!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    c3.pour(c2);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Poured 100ml ofamericano from one cup to another.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    c2.drink(<span style="color:#ae81ff">500</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// No americano left :(
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    c3.drink(<span style="color:#ae81ff">500</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Drank 300ml of americano.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Destructed americano.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// Destructed americano.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// Destructed espresso.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p>Иногда, определённые методы вызываются очень часто, и чтобы облегчить работу с ними, можно, вместо использования обычного метода, можно переопределить оператор:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#66d9ef">operator</span><span style="color:#f92672">&lt;&lt;</span>(Coffee <span style="color:#f92672">&amp;</span>other_cup)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Сравниваем адреса объектов, чтобы понять что это разные объекты
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(<span style="color:#66d9ef">this</span> <span style="color:#f92672">==</span> <span style="color:#f92672">&amp;</span>other_cup)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;Can&#39;t pour one cup into itself!&#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Сливаем только одинаковый тип кофе (чтобы не получить бурду)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span>(<span style="color:#f92672">!</span>strcmp(m_type, other_cup.m_type))
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Предположим, что у нас бесконечно глубокая кружка
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;Poured &#34;</span> <span style="color:#f92672">&lt;&lt;</span> other_cup.m_volume <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;ml of&#34;</span> <span style="color:#f92672">&lt;&lt;</span> m_type <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34; from one cup to another.&#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>		m_volume <span style="color:#f92672">+=</span> other_cup.m_volume;
</span></span><span style="display:flex;"><span>		other_cup.m_volume <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;Coffee types &#34;</span> <span style="color:#f92672">&lt;&lt;</span> m_type <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34; and &#34;</span> <span style="color:#f92672">&lt;&lt;</span> other_cup.m_type <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34; doesn&#39;t match!&#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>А переливание кофе будет выглядеть так:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>Coffee <span style="color:#a6e22e">c1</span>(<span style="color:#e6db74">&#34;espresso&#34;</span>, <span style="color:#f92672">+</span><span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">50</span>); 
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Created 50ml cup of hot espresso coffee.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>Coffee <span style="color:#a6e22e">c2</span>(<span style="color:#e6db74">&#34;americano&#34;</span>, <span style="color:#f92672">+</span><span style="color:#ae81ff">45</span>, <span style="color:#ae81ff">100</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Created 100ml cup of warm americano coffee.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>Coffee <span style="color:#a6e22e">c3</span>(<span style="color:#e6db74">&#34;americano&#34;</span>, <span style="color:#f92672">+</span><span style="color:#ae81ff">45</span>, <span style="color:#ae81ff">200</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Created 200ml cup of warm americano coffee.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>c3 <span style="color:#f92672">&lt;&lt;</span> c3;
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Can&#39;t pour one cup into itself!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>c3 <span style="color:#f92672">&lt;&lt;</span> c1;
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Coffee types americano and espresso doesn&#39;t match!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>c3 <span style="color:#f92672">&lt;&lt;</span> c2;
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Poured 100ml of americano from one cup to another.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>c2.drink(<span style="color:#ae81ff">500</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Drank 0ml of americano.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>c3.drink(<span style="color:#ae81ff">500</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Drank 300ml of americano.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Destructed americano.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Destructed americano.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Destructed espresso.
</span></span></span></code></pre></div><p>Как видишь, не особо много поменялось &ndash; просто метод теперь вызывается иначе.</p>
<p>Мы можем переопределить почти все операторы (в примерах &ldquo;a&rdquo; &ndash; наш класс, &ldquo;b&rdquo; &ndash; параметр):</p>
<ul>
<li>Присваивания: <code>a = b</code>, <code>a += b</code>, <code>a -= b</code>, <code>a \*= b</code>, <code>a /= b</code>, <code>a %= b</code>, <code>a &amp;= b</code>, <code>a |= b</code>, <code>a ^= b</code>, <code>a &lt;&lt;= b</code>, <code>a &gt;&gt;= b</code></li>
<li>Инкремента/декремента: <code>a++</code>, <code>++a</code>, <code>a--</code>, <code>--a</code></li>
<li>Арифметические: <code>+a</code>, <code>-a</code>, <code>a + b</code>, <code>a - b</code>, <code>a * b</code>, <code>a / b</code>, <code>a % b</code></li>
<li>Битовые: <code>~a</code>, <code>a &amp; b</code>, <code>a | b</code>, <code>a ^ b</code>, <code>a &lt;&lt; b</code>, <code>a &gt;&gt; b</code></li>
<li>Логические: <code>!a</code>, <code>a &amp;&amp; b</code>, <code>a || b</code></li>
<li>Сравнения: <code>a == b</code>, <code>a != b</code>, <code>a &lt; b</code>, <code>a &gt; b</code>, <code>a &lt;= b</code>, <code>a &gt;= b</code></li>
<li>Индексации: <code>a[b]</code></li>
<li>Вызова: <code>a(b)</code></li>
<li>Потокового ввода/вывода: <code>std::cin &gt;&gt; a</code>, <code>std::cout &lt;&lt; a</code></li>
<li>Доступа к полю: <code>a-&gt;b</code></li>
</ul>
<blockquote>
<p>Я перечислил большинство операторов, но если ты хочешь увидеть ещё парочку экзотичесих или узнать как определить тот или иной оператор &ndash; посмотри <a href="https://en.cppreference.com/w/cpp/language/operators">здесь</a>.</p>
</blockquote>
<p>Давай рассмотрим парочку моментов, которые пригодятся тебе при переопределении любого оператора.</p>
<h3 id="возвращаем-себя">Возвращаем себя</h3>
<p>Для примера, переопределим ещё постфиксный оператор &ldquo;++&rdquo; &ndash; он будет &ldquo;доливать&rdquo; 1 миллилитр кофе:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>Coffee<span style="color:#f92672">&amp;</span> <span style="color:#66d9ef">operator</span><span style="color:#f92672">++</span>(<span style="color:#66d9ef">int</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;Аdded 1ml of &#34;</span> <span style="color:#f92672">&lt;&lt;</span> m_type <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;.&#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>    m_volume<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">this</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
<p>Обрати внимание, что я указал int в параметрах &ndash; он нужен только для того, чтобы различать переопределение постфиксного оператора от префиксного.
Для префиксного оператора в параметрах ничего не указывается: <code>Coffee&amp; operator++()</code></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>Coffee <span style="color:#a6e22e">c1</span>(<span style="color:#e6db74">&#34;americano&#34;</span>, <span style="color:#ae81ff">75</span>, <span style="color:#ae81ff">100</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Constructed 100ml cup of hot americano coffee. 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>c1<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Added 1ml of americano.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>c1.drink(<span style="color:#ae81ff">200</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Drank 101ml of americano.
</span></span></span></code></pre></div><p>Обрати внимание на то, что мы возвращаем сами себя &ndash; Coffee&amp; (объект по ссылке). Можно и без этого, но благодаря этому можно делать так:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>Coffee <span style="color:#a6e22e">c1</span>(<span style="color:#e6db74">&#34;americano&#34;</span>, <span style="color:#ae81ff">75</span>, <span style="color:#ae81ff">100</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Constructed 200ml cup of hot americano coffee. 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>(c1<span style="color:#f92672">++</span>).drink(<span style="color:#ae81ff">200</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Added 1ml of americano.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Drank 101ml of americano.
</span></span></span></code></pre></div><p>Если тебе не нужно такое поведение, то можешь возвращать void.</p>
<h3 id="возвращаем-новый-объект">Возвращаем новый объект</h3>
<p>Иногда, нужно вернуть новый объект &ndash; чаще всего такое встречается с арифметическими операторами.</p>
<p>Давай переопределим оператор &ldquo;+&rdquo; &ndash; это мы будем сливать кофе из двух кружек в одну новую:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>Coffee <span style="color:#66d9ef">operator</span><span style="color:#f92672">+</span>(Coffee <span style="color:#f92672">&amp;</span>other)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Создали пустую кружку
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Coffee <span style="color:#a6e22e">new_cup</span>(m_type, m_temperature, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Сливаем туда себя и вторую кружку
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    new_cup <span style="color:#f92672">&lt;&lt;</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">this</span>;
</span></span><span style="display:flex;"><span>    new_cup <span style="color:#f92672">&lt;&lt;</span> other;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> new_cup;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Обрати внимание, что я возвращаю объект по значению (написал Coffee, а не Coffee&amp;) &ndash; в main() вернётся копия new_cup, а не она сама.</p>
<p>Вот как он используется и что выведется:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>Coffee <span style="color:#a6e22e">c1</span>(<span style="color:#e6db74">&#34;americano&#34;</span>, <span style="color:#ae81ff">75</span>, <span style="color:#ae81ff">125</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Constructed 125ml cup of hot americano coffee. 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>Coffee <span style="color:#a6e22e">c2</span>(<span style="color:#e6db74">&#34;americano&#34;</span>, <span style="color:#ae81ff">75</span>, <span style="color:#ae81ff">25</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Constructed 25ml cup of hot americano coffee. 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>Coffee c3 <span style="color:#f92672">=</span> c1 <span style="color:#f92672">+</span> c2;
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Constructed 0ml cup of hot americano coffee. 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Poured 125ml of americano from one cup to another.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Poured 25ml of americano from one cup to another.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>c1.drink(<span style="color:#ae81ff">20</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Drank 0ml of americano.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>c2.drink(<span style="color:#ae81ff">20</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Drank 0ml of americano.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>c3.drink(<span style="color:#ae81ff">20</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Drank 20ml of americano.
</span></span></span></code></pre></div><h3 id="не-возвращай-локальные-переменные-по-ссылке">Не возвращай локальные переменные по ссылке!</h3>
<p>В примере выше я возвращал локальную переменную new_cup по значению &ndash; а что было бы, если я вернул её по ссылке?</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>Coffee<span style="color:#f92672">&amp;</span> <span style="color:#66d9ef">operator</span><span style="color:#f92672">+</span>(Coffee <span style="color:#f92672">&amp;</span>other)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Создали пустую кружку
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Coffee <span style="color:#a6e22e">new_cup</span>(m_type, m_temperature, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Сливаем туду себя и вторую кружку
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    new_cup <span style="color:#f92672">&lt;&lt;</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">this</span>;
</span></span><span style="display:flex;"><span>    new_cup <span style="color:#f92672">&lt;&lt;</span> other;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> new_cup;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>При компиляции я получаю следующие предупреждения:</p>
<pre tabindex="0"><code>test.cpp:105:12: warning: reference to local variable ‘new_cup’ returned [-Wreturn-local-addr]
105 |     return new_cup;
    |            ^~~~~~~
test.cpp:101:12: note: declared here
101 |     Coffee new_cup(m_type, m_temperature, 0);
    |            ^~~~~~~
</code></pre><p>При запуске я ловлю экстренное прерывание программы:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>Coffee <span style="color:#a6e22e">c1</span>(<span style="color:#e6db74">&#34;americano&#34;</span>, <span style="color:#ae81ff">75</span>, <span style="color:#ae81ff">125</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Constructed 125ml cup of hot americano coffee. 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>Coffee <span style="color:#a6e22e">c2</span>(<span style="color:#e6db74">&#34;americano&#34;</span>, <span style="color:#ae81ff">75</span>, <span style="color:#ae81ff">25</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Constructed 25ml cup of hot americano coffee. 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>Coffee<span style="color:#f92672">&amp;</span> c3 <span style="color:#f92672">=</span> c1 <span style="color:#f92672">+</span> c2;
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Constructed 0ml cup of hot americano coffee. 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Poured 125ml of americano from one cup to another.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Poured 25ml of americano from one cup to another.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Destructed americano.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>c1.drink(<span style="color:#ae81ff">20</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Drank 0ml of americano.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>c2.drink(<span style="color:#ae81ff">20</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Drank 0ml of americano.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>c3.drink(<span style="color:#ae81ff">20</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Segmentation fault (core dumped)
</span></span></span></code></pre></div><p>Вот последовательность событий:</p>
<ul>
<li>Вызов operator+()</li>
<li>Создание локальной переменной new_cup</li>
<li>Вызов операторов &ldquo;переливания&rdquo; для this и other</li>
<li>Возвращение new_cup в main и сохранение его в c3 (обрати внимание, что я указал тип переменной как Coffee&amp;, чтобы не было копирования)</li>
<li>Удаление локальной переменной new_cup (память под этот объект полностью освобождена)</li>
<li>Выход из operator+()</li>
<li>Вызов drink() для нормальных c1 и c2</li>
<li>Попытка вызвать drink() у объекта c3, которого уже не существует</li>
</ul>
<p>Если сложно понять что происходит, то можно представить что new_cup возвращается через указатель:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>Coffee<span style="color:#f92672">*</span> <span style="color:#66d9ef">operator</span><span style="color:#f92672">+</span>(Coffee <span style="color:#f92672">&amp;</span>other)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    Coffee <span style="color:#a6e22e">new_cup</span>(m_type, m_temperature, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    new_cup <span style="color:#f92672">&lt;&lt;</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">this</span>;
</span></span><span style="display:flex;"><span>    new_cup <span style="color:#f92672">&lt;&lt;</span> other;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span>new_cup;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>А в main():</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// Вывод такой же как в прошлом примере
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>Coffee <span style="color:#a6e22e">c1</span>(<span style="color:#e6db74">&#34;americano&#34;</span>, <span style="color:#ae81ff">75</span>, <span style="color:#ae81ff">125</span>);
</span></span><span style="display:flex;"><span>Coffee <span style="color:#a6e22e">c2</span>(<span style="color:#e6db74">&#34;americano&#34;</span>, <span style="color:#ae81ff">75</span>, <span style="color:#ae81ff">25</span>);
</span></span><span style="display:flex;"><span>Coffee<span style="color:#f92672">*</span> c3 <span style="color:#f92672">=</span> c1 <span style="color:#f92672">+</span> c2;
</span></span><span style="display:flex;"><span>c1.drink(<span style="color:#ae81ff">20</span>);
</span></span><span style="display:flex;"><span>c2.drink(<span style="color:#ae81ff">20</span>);
</span></span><span style="display:flex;"><span>c3<span style="color:#f92672">-&gt;</span>drink(<span style="color:#ae81ff">20</span>);
</span></span></code></pre></div><h1 id="заключение">Заключение</h1>
<p>Уфффф! Если операторы ещё более-менее понятны, то вот с этими ссылками было жёстко!</p>
<p>Ладно, я надеюсь, что у меня получилось разобрать и собрать у тебя в голове этот паззл. Если нет, то пиши &ndash; я отвечу на все вопросы.</p>
<p>Дальше на очереди &ndash; окончательно разбираемся с конструкторами.</p>

    <hr>
    <div align="center">
        <a href="https://kee-reel.com/cpp/operators/#top">▲ В начало ▲</a>
    </div>
    
        <hr>
        <div style="display: flex; justify-content: space-between;">
            
                <a href="https://kee-reel.com/cpp/classes/">◀ Классы</a>
            
            
                <a href="https://kee-reel.com/cpp/constructors/">Конструкторы, оператор присваивания и деструктор ▶</a>
            
        </div>
    

			</section>
		</div>
	</div>

    <footer>
    <hr>
    <div align="center">
        Home server: Raspberry Pi 4<br>
        Temperature: 53<br>
Uptime: 1 hour, 7 minutes
    </div>
</footer>

</body>
</html>
